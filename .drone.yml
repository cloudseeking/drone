---
kind: pipeline
type: kubernetes
name: Terraform Plan & Apply

trigger:
  branch:
  - main
  when:
    event:
      exclude:
      - pull_request   

steps:
- name: terraform-plan
  image: jmccann/drone-terraform:1
  settings:
    plan: true
    root_dir: .
    parallelism: 4
    sensitive: true
    vars:
      ARM_CLIENT_ID:
        from_secret: ARM_CLIENT_ID
      ARM_CLIENT_SECRET:
        from_secret: ARM_CLIENT_SECRET 
      ARM_SUBSCRIPTION_ID:
        from_secret: ARM_SUBSCRIPTION_ID
      ARM_TENANT_ID:
        from_secret: ARM_TENANT_ID

- name: terraform-apply
  image: jmccann/drone-terraform:1
  settings:
    plan: false
    root_dir: .
    parallelism: 4
    sensitive: true
    vars:
      ARM_CLIENT_ID:
        from_secret: ARM_CLIENT_ID
      ARM_CLIENT_SECRET:
        from_secret: ARM_CLIENT_SECRET 
      ARM_SUBSCRIPTION_ID:
        from_secret: ARM_SUBSCRIPTION_ID
      ARM_TENANT_ID:
        from_secret: ARM_TENANT_ID